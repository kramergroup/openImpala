# Singularity Definition File for OpenImpala Application
# BUILDS FROM PRE-COMPILED DEPENDENCIES

Bootstrap: docker
From: quay.io/rockylinux/rockylinux:8
Stage: final

%help
    Container with the OpenImpala application.
    Built using pre-compiled dependencies for a fast and efficient workflow.

%files
    # Copy the local project directory into the container for building.
    . /opt/openImpala

%post
    set -e
    
    echo "--- Copying pre-compiled dependencies from bind mount ---"
    # This copies the libraries made available via the --bind flag in the build command.
    cp -a /deps/opt/. /opt/
    cp -a /deps/usr/local/. /usr/local/

    echo "--- Installing temporary build tools ---"
    dnf update -y
    dnf install -y '@Development Tools' gcc-toolset-11
    
    echo "--- Updating library cache ---"
    echo "/usr/local/lib" > /etc/ld.so.conf.d/openmpi.conf
    ldconfig
    
    echo "--- Building OpenImpala application ---"
    source /opt/rh/gcc-toolset-11/enable
    cd /opt/openImpala
    make -j$(nproc) all
    
    echo "--- Cleaning up build dependencies ---"
    dnf remove -y '@Development Tools' gcc-toolset-11
    dnf clean all -y
    
    echo "--- Build process complete ---"

# The %environment and %runscript sections remain the same as before.
%environment
    source /opt/rh/gcc-toolset-11/enable
    export LC_ALL=C; export LANG=C

    export AMREX_INSTALL_PREFIX=/opt/amrex/25.03
    export HYPRE_INSTALL_PREFIX=/opt/hypre/v2.32.0
    export OPENMPI_INSTALL_PREFIX=/usr/local
    export HDF5_INSTALL_PREFIX=/opt/hdf5/1.12.3
    export LIBTIFF_INSTALL_PREFIX=/opt/libtiff/4.6.0
    export OPENIMPALA_INSTALL_DIR=/opt/openImpala

    export AMREX_HOME=${AMREX_INSTALL_PREFIX}
    export HYPRE_HOME=${HYPRE_INSTALL_PREFIX}
    export HDF5_HOME=${HDF5_INSTALL_PREFIX}
    export TIFF_HOME=${LIBTIFF_INSTALL_PREFIX}

    export PATH=${OPENIMPALA_INSTALL_DIR}/build/apps:${OPENIMPALA_INSTALL_DIR}/build/tests:${AMREX_HOME}/bin:${HYPRE_HOME}/bin:${HDF5_HOME}/bin:${LIBTIFF_INSTALL_PREFIX}/bin:${OPENMPI_INSTALL_PREFIX}/bin:${PATH}
    export LD_LIBRARY_PATH=${AMREX_HOME}/lib:${HYPRE_HOME}/lib:${HDF5_HOME}/lib:${LIBTIFF_INSTALL_PREFIX}/lib:${OPENMPI_INSTALL_PREFIX}/lib:${LD_LIBRARY_PATH}

    export OMPI_MCA_btl_vader_single_copy_mechanism=none
    export OMPI_MCA_rmaps_base_oversubscribe=1

%runscript
    exec "$@"
