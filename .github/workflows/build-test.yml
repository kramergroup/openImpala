# .github/workflows/build-test.yml
name: Build and Test OpenImpala Makefile with SIF Cache

# Define workflow triggers
on:
  push:
    # Trigger on pushes to these specific branches
    branches:
      - main
      - working
      - build
      - 'makefile' # Include makefile branch trigger
  pull_request:
    # Trigger on Pull Requests targeting main branch
    branches: [ main ]
  workflow_dispatch: # Allows manual triggering

jobs:
  build-and-test-openimpala: # Renamed job for clarity
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the repository code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Install Apptainer
      - name: Set up Apptainer
        uses: eWaterCycle/setup-apptainer@v2
        with:
          apptainer-version: 1.2.5

      # Step 3: Restore Dependency SIF Cache
      - name: Restore Dependency SIF Cache
        id: cache-restore-sif
        uses: actions/cache/restore@v4
        with:
          path: dependency_image.sif
          key: ${{ runner.os }}-apptainer-sif-${{ hashFiles('containers/Singularity.deps.def') }}
          restore-keys: |
            ${{ runner.os }}-apptainer-sif-

      # Step 3.5: Debug cache hit status
      - name: Debug cache hit status
        if: always()
        run: echo "Cache hit status is >>>${{ steps.cache-restore-sif.outputs.cache-hit }}<<<"

      # Step 4: Build Dependency SIF Image (if cache miss)
      - name: Build Dependency SIF Image Locally (if cache miss)
        if: steps.cache-restore-sif.outputs.cache-hit != 'true'
        run: |
          RECIPE_FILE="containers/Singularity.deps.def"
          TARGET_SIF="dependency_image.sif"
          if [ ! -f "$RECIPE_FILE" ]; then
            echo "Error: Dependency recipe file $RECIPE_FILE not found!"
            exit 1
          fi
          echo "Cache miss or invalid. Building dependencies SIF image '$TARGET_SIF' from $RECIPE_FILE..."
          echo "Executing: sudo apptainer build --force \"$TARGET_SIF\" \"$RECIPE_FILE\""
          sudo apptainer build --force "$TARGET_SIF" "$RECIPE_FILE"
          BUILD_EXIT_CODE=$?
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "Error: Apptainer SIF build failed with exit code $BUILD_EXIT_CODE."
            exit $BUILD_EXIT_CODE # Job stops here if SIF build fails
          fi
          echo "Apptainer SIF build successful."
          ls -lh ./dependency_image.sif

      # Step 5: Verify SIF exists
      - name: Verify SIF exists after cache/build step
        run: |
          if [ ! -f "./dependency_image.sif" ]; then
            echo "Error: dependency_image.sif not found after cache/build steps!"
            exit 1
          else
            echo "dependency_image.sif found."
            ls -lh ./dependency_image.sif
          fi

      # Step 6: Save the SIF image to the cache <<< MOVED & RENUMBERED (was Step 12)
      - name: Save Dependency SIF Image Cache
        # Condition: Only run if Step 3 missed cache (meaning Step 4 ran and *succeeded*)
        if: steps.cache-restore-sif.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: dependency_image.sif
          key: ${{ runner.os }}-apptainer-sif-${{ hashFiles('containers/Singularity.deps.def') }}

      # Step 7: Build OpenImpala using Dependency SIF <<< RENUMBERED (was Step 6)
      - name: Build OpenImpala using Dependency SIF
        id: make_build
        continue-on-error: true # Allow logs to upload even if build fails
        run: |
          echo "Running make clean..."
          sudo apptainer exec \
            --bind $PWD:/src \
            ./dependency_image.sif \
            bash -c 'source /opt/rh/gcc-toolset-11/enable && cd /src && make clean'

          echo "Running make all..."
          sudo apptainer exec \
            --bind $PWD:/src \
            ./dependency_image.sif \
            bash -c 'source /opt/rh/gcc-toolset-11/enable && cd /src && make all -j$(nproc)' > make_build_output.log 2>&1
          MAKE_EXIT_CODE=$?
          echo "Make build exit code: $MAKE_EXIT_CODE"
          exit $MAKE_EXIT_CODE

      # Step 8: Upload Build Log <<< RENUMBERED (was Step 7)
      - name: Upload Build Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: make-build-log-${{ github.run_id }}
          path: make_build_output.log
          retention-days: 5
          if-no-files-found: warn

      # Step 9: Explicitly fail the JOB if the make build step failed <<< RENUMBERED (was Step 8)
      - name: Check build outcome
        if: steps.make_build.outcome == 'failure'
        run: |
          echo "Make build command failed. See uploaded 'make-build-log' artifact for details."
          exit 1 # Job stops here if make build failed

      # Step 9.5: Check Test TIFF File Before Running Tests
      - name: Check Test TIFF File Status Inside Container
        # Run only if build succeeded, before running tests
        if: steps.make_build.outcome == 'success'
        run: |
          echo "Checking status of data/SampleData_2Phase.tif inside container..."
          TARGET_FILE="data/SampleData_2Phase.tif"
          sudo apptainer exec \
            --bind $PWD:/src \
            ./dependency_image.sif \
            bash -c "cd /src && \
                     echo '--- Running ls -l:' && \
                     ls -l \"${TARGET_FILE}\" && \
                     echo '--- Running file command:' && \
                     file \"${TARGET_FILE}\" && \
                     echo '--- Running tiffinfo:' && \
                     tiffinfo \"${TARGET_FILE}\"" || echo "::warning::Checking test file failed, proceeding anyway..."
          echo "Finished checking test file status."

      # Step 10: Run Tests and Copy Backtrace <<< RENUMBERED (was Step 9)
      - name: Run Tests and Copy Backtrace
        id: make_test
        # This step is only reached if the build (Step 7/9) succeeded
        if: steps.make_build.outcome == 'success'
        continue-on-error: true # Keep this true
        run: |
          echo "Running make test..."
          # Add timeout (e.g., 1200 seconds = 20 minutes). Adjust time as needed.
          # Run tests within timeout, redirect stdout/stderr to log file
          timeout 1200 sudo apptainer exec \
            --bind $PWD:/src \
            ./dependency_image.sif \
            bash -c 'source /opt/rh/gcc-toolset-11/enable && cd /src && make test' > make_test_output.log 2>&1
          TEST_EXIT_CODE=$?
          # Check if timeout occurred (exit code 124 for GNU timeout)
          if [ $TEST_EXIT_CODE -eq 124 ]; then
             echo "::error::Test step timed out after 20 minutes!"
             # The job will fail later based on steps.make_test.outcome == 'failure' anyway,
             # but this provides an explicit error message in the logs.
          fi
          echo "Make test exit code: $TEST_EXIT_CODE"

          # --- Attempt to copy Backtrace files from container's /src to host's PWD ---
          echo "Attempting to find and copy Backtrace files from /src inside container..."
          # Use find within the container, execute cp to copy to the bound /src dir ($PWD). Ignore errors if not found.
          sudo apptainer exec \
            --bind $PWD:/src \
            ./dependency_image.sif \
            bash -c 'find /src -maxdepth 1 -name "Backtrace.*" -exec echo "==> Found Backtrace file:" {} \; -exec cp {} /src/ \;' || true

          echo "Listing files in PWD (workspace: $PWD) after copy attempt:"
          ls -la "$PWD"
          # --- End copy attempt ---

          # Exit step with the original test exit code
          echo "Exiting step with original test code: $TEST_EXIT_CODE"
          exit $TEST_EXIT_CODE

      # Step 11: Upload Test Log and Backtrace <<< RENUMBERED (was Step 10)
      - name: Upload Test Log and Backtrace
        # This step runs even if make_test failed (due to continue-on-error), but only if build succeeded
        if: always() && steps.make_build.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: make-test-output-${{ github.run_id }}
          path: |
            make_test_output.log
            Backtrace.*
          retention-days: 5
          if-no-files-found: warn # Use warn instead of error if no backtrace files found

      # Step 12: Explicitly fail the JOB if the make test step failed <<< RENUMBERED (was Step 11)
      - name: Check test outcome
        # This step is only reached if the build (Step 7/9) succeeded
        if: steps.make_build.outcome == 'success' && steps.make_test.outcome == 'failure'
        run: |
          echo "Make test command failed. See uploaded 'make-test-output' artifact for details."
          exit 1 # Job stops here if make test failed
